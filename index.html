<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>pcfinancial</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="pcfinancial"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-01-09T13:01-0700"/>
<meta name="author" content="Warren Wilkinson"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">pcfinancial</h1>



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Overview</a>
<ul>
<li><a href="#sec-1-1">1.1 Features</a></li>
<li><a href="#sec-1-2">1.2 Limitations</a></li>
</ul>
</li>
<li><a href="#sec-2">2 Installation</a>
<ul>
<li><a href="#sec-2-1">2.1 Quick Lisp</a></li>
<li><a href="#sec-2-2">2.2 Gentoo</a></li>
<li><a href="#sec-2-3">2.3 Ubunto</a></li>
<li><a href="#sec-2-4">2.4 Manual Installation</a></li>
<li><a href="#sec-2-5">2.5 Getting Support</a></li>
</ul>
</li>
<li><a href="#sec-3">3 Implementation</a>
<ul>
<li><a href="#sec-3-1">3.1 Logging In</a></li>
<li><a href="#sec-3-2">3.2 Downloading Transactions</a></li>
<li><a href="#sec-3-3">3.3 Logging Out</a></li>
<li><a href="#sec-3-4">3.4 Other Utilities</a></li>
</ul>
</li>
<li><a href="#sec-4">4 License</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">


<p>
The pcfinancial package uses Drakma to download CSV data from the PC Financial website. 
</p>



<pre class="example">(pcf:login "your-password" "cardNumber-from-your-cookie")
(setf *csv-data* (pcf:download-transactions "your-account" (encode-universal-time 0 0 0 day month year)))
(pcf:logoff)
</pre>


<p>
You need 3 magic values to make it work. You can get most of them through creative web browsing.
</p>
<ul>
<li>Your Password in plain text (the transfer is done using SSH though, so it's secure I guess).
</li>
<li>cardNumber as found in a cookie from your webbrowser.  It's a hashed value (I think). If you have many cards,
   get a unique cookie for each one by using incognito browser mode and PCFinancials 'add card' option on the login page.
</li>
<li>your-account is a string in the form "##,#####,##############".  Log in with a web browser and inspect the 
   'Account' select options on the download page (<a href="https://www.txn.banking.pcfinancial.ca/a/banking/accounts/downloadTransactions1.ams">https://www.txn.banking.pcfinancial.ca/a/banking/accounts/downloadTransactions1.ams</a>).
</li>
</ul>



</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Features</h3>
<div class="outline-text-3" id="text-1-1">


<ul>
<li>Login, Logoff and download transactions.
</li>
<li>Omitting the 'since' date from download transactions will cause it to download all since last download.
</li>
</ul>


</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Limitations</h3>
<div class="outline-text-3" id="text-1-2">


<ul>
<li>It doesn't parse the CSV.
</li>
<li>Can't help you find the magic numbers.
</li>
<li>It's a scrapper, so if the PCfinancial site changes, this will break..
</li>
<li>There are no tests.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Installation</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Quick Lisp</h3>
<div class="outline-text-3" id="text-2-1">


<p>
Install <a href="http://www.quicklisp.org/beta/">Quick Lisp</a> and then run:
</p>



<pre class="example">(ql:quickload 'cl-pcfinancial)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section, and you may want to <a href="#runtests">run the tests</a>.
</p>
</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Gentoo</h3>
<div class="outline-text-3" id="text-2-2">


<p>
As root, 
</p>



<pre class="example">emerge cl-pcfinancial
</pre>


<p>
Once the emerge is finished, the package can be loaded using ASDF:
</p>


<pre class="example">(asdf:operate 'asdf:load-op :cl-pcfinancial)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section.
</p>
</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Ubunto</h3>
<div class="outline-text-3" id="text-2-3">





<pre class="example">sudo apt-get install cl-pcfinancial
</pre>


<p>
Once the installation is finished, the package is loadable using ASDF:
</p>



<pre class="example">(asdf:operate 'asdf:load-op :cl-pcfinancial)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section.
</p>
</div>

</div>

<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Manual Installation</h3>
<div class="outline-text-3" id="text-2-4">


<p>
In summary: Untar the <a href="https://github.com/WarrenWilkinson/cl-pcfinancial/archive/master.tar.gz">.tar</a> package and then symlink the .asd files into a place where ASDF can find them. 
</p>
<ol>
<li>Untar the files where you want them to be.  On windows download the <a href="https://github.com/WarrenWilkinson/cl-pcfinancial/archive/master.zip">.zip</a> and unzip it instead, it's the same files.
</li>
<li>ASDF could be looking anywhere &ndash; it depends on your setup.  Run this in your lisp repl to get a clue
     as to where ASDF is seeking libraries<sup><a class="footref" name="fnr-.1" href="#fn-.1">1</a></sup>:




<pre class="example">(mapcan #'funcall asdf:*default-source-registries*)
</pre>


</li>
<li>Symlink the .asd files to the source directory. If you use windows, <a href="http://bc.tech.coop/blog/041113.html">these instructions on symlink alternatives apply to you</a>.
</li>
</ol>


<p>
Once the files are in place, the package can be loaded with ASDF by:
</p>


<pre class="example">(asdf:operate 'asdf:load-op :cl-pcfinancial)
</pre>


<p>
If you have problems, see the <a href="#support">support</a> section. 
</p>
</div>

</div>

<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> Getting Support</h3>
<div class="outline-text-3" id="text-2-5">


<p>
You can find support on this libraries <a href="http://warrenwilkinson.ca/cl-pcfinancial">website</a> and/or <a href="https://github.com/WarrenWilkinson/cl-pcfinancial">github</a> repository. Or you can email <a href="mailto:warrenwilkinson@gmail.com">Warren Wilkinson</a>.
</p>
</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Implementation</h2>
<div class="outline-text-2" id="text-3">


<p>
This library is a thin layer on top of Drakma. It provides nearly no features, and that is my intention.
Scrapping is volatile because it relies on unreliable things.
</p>
<ol>
<li>The source website
</li>
<li>Your internet connection
</li>
<li>Magic numbers, cookies, etc.
</li>
</ol>


<p>
This tiny library may break occasionally, but we'll know the error is somewhere in
it's 85 loc.  If it had features, debugging would be hard: is it broken or has the 
underlying website changed?
</p>

</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Logging In</h3>
<div class="outline-text-3" id="text-3-1">


<p>
A cookie-jar is created/bound and it has your cardNumber.  Then we log in with your password and cardNumber 0.
</p>



<pre class="example">(defun login (password cardNumber)
  (if *cookie-jar*
      (error "Already logged in...")
      (setf *cookie-jar* 
            (make-instance 'drakma:cookie-jar
                           :cookies (list
                                     (make-instance 'drakma:cookie 
                                                    :name "cardNumber"
                                                    :value cardNumber 
                                                    :domain "www.txn.banking.pcfinancial.ca")))))
  (submit-to "https://www.txn.banking.pcfinancial.ca/a/authentication/signOn.ams"
             (cons "cardNumberSaved" "0")
             (cons "password" password)))
</pre>


</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Downloading Transactions</h3>
<div class="outline-text-3" id="text-3-2">


<p>
Once logged in, we can just post the required variables! 
</p>



<pre class="example">(defun download-transactions (account &amp;optional since)
  (multiple-value-bind (sec min hour day month year) (decode-universal-time (or since (get-universal-time)))
    (declare (ignore sec min hour))
    (setf month (princ-to-string (decf month))
          year (princ-to-string year)
          day (princ-to-string day))
    (submit-to "https://www.txn.banking.pcfinancial.ca/a/banking/accounts/downloadTransactions2.ams"
               (cons "fromAccount" account)
               (cons "sinceLastDownload" (if since "false" "true"))
               (cons "previewDownload" "false")
               (cons "pfmSoftware" "other")
               (cons "fromDate__YEAR" year)
               (cons "fromDate__MONTH" month)
               (cons "fromDate__DAY" day))))
</pre>


</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Logging Out</h3>
<div class="outline-text-3" id="text-3-3">


<p>
Go to the signOff page and set our cookie-jar to nil.
</p>



<pre class="example">(defun logout ()
  (multiple-value-prog1 (open-url "https://www.txn.banking.pcfinancial.ca/a/authentication/signOff.ams")
    (setf *cookie-jar* nil)))
</pre>


</div>

</div>

<div id="outline-container-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Other Utilities</h3>
<div class="outline-text-3" id="text-3-4">


<p>
For reading the CSV data, I recommend <a href="http://warrenwilkinson.ca/read-csv">read-csv</a><a href="#fn-A-lisp-library-for-parsing-CSV-also-written-by-me.">fn: A lisp library for parsing CSV, also written by me.</a>.
</p>
<p>
Within this package are some utilities to split PC Finance's date format (mm/dd/yyyy) into Y, M, D.
</p>



<pre class="example">(defun string-date-to-ymd (date)
  (values (parse-integer (subseq date 6 10))
          (parse-integer (subseq date 0 2))
          (parse-integer (subseq date 3 5))))

(defun string-date-to-universal-time (date)
  (multiple-value-bind (y m d) (pc-financial-date-to-ymd date)
    (encode-universal-time 0 0 0 d m y)))
</pre>


</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> License</h2>
<div class="outline-text-2" id="text-4">


<p>
cl-pcfinancial is distributed under the <a href="http://opensource.org/licenses/mit-license.php">MIT</a> license.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn-.1" href="#fnr-.1">1</a></sup> you might need to (require 'asdf) before running this example
</p>


</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-01-09T13:01-0700</p>
<p class="author">Author: Warren Wilkinson</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.2 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
